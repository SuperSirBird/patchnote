<html>
  <head>
    <title>patchscrapworld - SuperSirBird</title>
    <style>
      body {margin:0px;}
    </style>
  </head>
  <body>
    <canvas id="myCanvas" onmousemove="mouseupdate(event)">
      Sorry :/ your browser does not support the canvas element
    </canvas>
    <script>
      
      /* 
      Engine made by SuperSirBird
      */
      
      var c = document.getElementById("myCanvas");
      var ctx=c.getContext("2d");
      c.width  = window.innerWidth;
      c.height = window.innerHeight;
      
      var xa;
      var ya;
      var za;
      var xrot = 0;
      var yrot = 0;
      var dis;
      var dir;
      
      var playerx = 0;
      var playery = 0;
      var playerz = -200;
      
      var objx = [];
      var objy = [];
      var objz = [];
      var facemark = [];
      var faceave = [];
      var orderface = [];
      
      var blockx = [];
      var blocky = [];
      var blockz = [];
      var blockr = [];
      
      var yv = 0;
      
      var keys = {};
      window.onkeyup = function(e) { keys[e.keyCode] = false; }
      window.onkeydown = function(e) { keys[e.keyCode] = true; }
      
      function createcube(x_,y_,z_,r) {
        
        blockx.push(x_);
        blocky.push(y_);
        blockz.push(z_);
        blockr.push(r);
        
        // xy faces
        objx.push([x_-r,x_+r,x_-r,x_+r],[x_-r,x_+r,x_-r,x_+r]);
        objy.push([y_+r,y_+r,y_-r,y_-r],[y_+r,y_+r,y_-r,y_-r]);
        objz.push([z_-r,z_-r,z_-r,z_-r],[z_+r,z_+r,z_+r,z_+r]);
        facemark.push("f");
        faceave.push(0);
        facemark.push("f");
        faceave.push(0);
        // zy faces
        objz.push([z_-r,z_+r,z_-r,z_+r],[z_-r,z_+r,z_-r,z_+r]);
        objy.push([y_+r,y_+r,y_-r,y_-r],[y_+r,y_+r,y_-r,y_-r]);
        objx.push([x_-r,x_-r,x_-r,x_-r],[x_+r,x_+r,x_+r,x_+r]);
        facemark.push("f");
        faceave.push(0);
        facemark.push("f");
        faceave.push(0);
        // xz faces
        objx.push([x_-r,x_+r,x_-r,x_+r],[x_-r,x_+r,x_-r,x_+r]);
        objz.push([z_+r,z_+r,z_-r,z_-r],[z_+r,z_+r,z_-r,z_-r]);
        objy.push([y_-r,y_-r,y_-r,y_-r],[y_+r,y_+r,y_+r,y_+r]);
        facemark.push("f");
        faceave.push(0);
        facemark.push("f");
        faceave.push(0);
      }
      
      function rotpoint(x_,y_,z_,xr,yr) {
        xa = x_-playerx;
        ya = y_-playery-70;
        za = z_-playerz;
        
        dis = Math.sqrt((xa*xa) + (za*za));
        dir = Math.atan(xa/za); 
        if (za<0) {dir+=Math.PI} if (za===0) {if (xa > 0) {dir = Math.PI/2} else {dir = -Math.PI/2}}
        
        xa = dis*(Math.sin(dir + xr));
        za = dis*(Math.cos(dir + xr));
        
        dis = Math.sqrt((za*za) + (ya*ya));
        dir = Math.atan(ya/za); 
        if (za<0) {dir+=Math.PI} if (za===0) {if (ya > 0) {dir = Math.PI/2} else {dir = -Math.PI/2}}
        
        ya = dis*(Math.sin(dir + yr));
        za = dis*(Math.cos(dir + yr));
      }
      
      function calcpoints() {
        for (var i = 0;i<objx.length;i++) {
          var faceave_c = 0;
          for (var c = 0;c<objx[i].length;c++) {
            rotpoint(objx[i][c],objy[i][c],objz[i][c],xrot,yrot)
            objx[i][c] = xa;
            objy[i][c] = ya;
            objz[i][c] = za;
            faceave_c += Math.sqrt(za*za + xa*xa + ya*ya);
          }
          faceave_c = faceave_c/objx[i].length;
          faceave[i] = faceave_c;
        }
      }
      
      function orderfaces() {
        
        for (var i = 0;i<objx.length;i++) {
          facemark[i] = "f";
        }
        
        for (var i = 0;i<objx.length;i++) {
          var highest_z = -999999;
          var highest_i = 0;
          for (var c = 0;c<objx.length;c++) {
            if (facemark[c] === "f") {
              if (faceave[c] > highest_z) {
                highest_z = faceave[c];
                highest_i = c;
              }
            }
          }
          
          orderface.push(highest_i);
          facemark[highest_i] = "t";
          
        }
      }
      
      function perspec(x_,y_,z_) {
        xa = (c.width/2) + 200*((x_/((z_/2))));
        ya = (c.height/2) - 200*((y_/((z_/2))));
      }
      
      function drawfaces() {
        for (var i = 0;i<orderface.length;i++) {
          
          var shade = Math.abs(objx[orderface[i]][1]-objx[orderface[i]][0])/Math.sqrt(((objx[orderface[i]][1]-objx[orderface[i]][0])*(objx[orderface[i]][1]-objx[orderface[i]][0]) + ((objz[orderface[i]][1]-objz[orderface[i]][0])*(objz[orderface[i]][1]-objz[orderface[i]][0]))));
          
          ctx.fillStyle = "rgb(" + (50+shade*150) + "," + (50+shade*150) + "," + (50+shade*150) + ")";
          
          ctx.beginPath();
          if (objz[orderface[i]][0] > 0) {
          perspec(objx[orderface[i]][0],objy[orderface[i]][0],objz[orderface[i]][0]);
          ctx.moveTo(xa, ya);}
          if (objz[orderface[i]][1] > 0) {
          perspec(objx[orderface[i]][1],objy[orderface[i]][1],objz[orderface[i]][1]);
          ctx.lineTo(xa, ya);}
          if (objz[orderface[i]][3] > 0) {
          perspec(objx[orderface[i]][3],objy[orderface[i]][3],objz[orderface[i]][3]);
          ctx.lineTo(xa, ya);}
          if (objz[orderface[i]][2] > 0) {
          perspec(objx[orderface[i]][2],objy[orderface[i]][2],objz[orderface[i]][2]);
          ctx.lineTo(xa, ya);}
          ctx.closePath();
          ctx.fill();
        }
      }
      
      function physics() {
        
        // Jump Physics
        
        var allowjump = "f";
        
        playery += yv;
        yv -= 1;
        if (playery < 0) {playery = 0; yv = 0; allowjump = "t";}
        
        // Collision Physics for Blocks
        
        for (var i = 0;i<blockx.length;i++) {
          if (playerx > blockx[i]-blockr[i] && playerx < blockx[i]+blockr[i]) {
            if (playerz > blockz[i]-blockr[i] && playerz < blockz[i]+blockr[i]) {
              if ((playery > blocky[i]-blockr[i] && playery < blocky[i]+blockr[i]) || ((playery + 70) > blocky[i]-blockr[i] && (playery + 70) < blocky[i]+blockr[i])) {
                //yv = 0;
                //playery = blocky[i]+blockr[i];
                //allowjump = "t";
                
                // Test if y is above center
                var addr = 0;
                if (playery > blocky[i]) {addr = 0} else {addr = 70}
                
                if (Math.abs(Math.abs(playerx-blockx[i])-blockr[i]) < Math.abs(Math.abs(playerz-blockz[i])-blockr[i]) && Math.abs(Math.abs(playerx-blockx[i])-blockr[i]) < Math.abs(Math.abs((playery+addr)-blocky[i])-blockr[i])) {
                  if (playerx > blockx[i]) {playerx = blockx[i]+blockr[i]} else {playerx = blockx[i]-blockr[i]}
                } else {
                  
                  // Test if y is above center

                  if (Math.abs(Math.abs((playerz)-blockz[i])-blockr[i]) < Math.abs(Math.abs((playery+addr)-blocky[i])-blockr[i])) {
                    if (playerz > blockz[i]) {playerz = blockz[i]+blockr[i]} else {playerz = blockz[i]-blockr[i]}
                  } else {
                    if (playery > blocky[i]) {playery = blocky[i]+blockr[i]; yv = 0} else {playery = blocky[i]-blockr[i]-70}
                  }
                  
                }
                
              }
            }
          }
        }
        
        if (keys["32"] && allowjump === "t") { // Jump
          yv = 28;
        }
        
      }
      
      function step() {
        ctx.clearRect(0, 0, c.width, c.height);
        blockx = [];
        blocky = [];
        blockz = [];
        blockr = [];
        objx = [];
        objy = [];
        objz = [];
        facemark = [];
        faceave = [];
        orderface = [];
        
        createcube(0,100,0,100);
        createcube(300,100,0,100);
        createcube(-300,100,0,100);
        
        createcube(0,400,0,100);
        
        controls();
        physics();
        
        calcpoints();
        orderfaces();
        drawfaces();
        window.requestAnimationFrame(step);
      }
      
      function mouseupdate(event) {
        //xrot = ((event.clientX-c.width/2)/180)*Math.PI;
        //yrot = (((c.height/2)-event.clientY)/180)*Math.PI;
      }
      
      function controls() {
        if (keys["38"]) {yrot-=(3/180)*Math.PI} // Up
        if (keys["40"]) {yrot+=(3/180)*Math.PI} // Down
        if (keys["37"]) {xrot+=(3/180)*Math.PI} // Left
        if (keys["39"]) {xrot-=(3/180)*Math.PI} // Right
        
        if (keys["87"]) { // Forward 
          playerx += 3*Math.sin(-xrot);
          playerz += 3*Math.cos(-xrot);
        }
        if (keys["83"]) { // Backward
          playerx -= 3*Math.sin(-xrot);
          playerz -= 3*Math.cos(-xrot);
        }
        if (keys["65"]) { // Left
          playerx += 3*Math.sin((-xrot)-(Math.PI/2));
          playerz += 3*Math.cos((-xrot)-(Math.PI/2));
        }
        if (keys["68"]) { // Right
          playerx += 3*Math.sin((-xrot)+(Math.PI/2));
          playerz += 3*Math.cos((-xrot)+(Math.PI/2));
        }
      }
      
      
      window.requestAnimationFrame(step);
      
    </script>
  </body>
</html>
